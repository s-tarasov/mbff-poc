
# протокол аутентификации систем (клиента)

## Context and Problem Statement
Веб приложение и мобильное приложение принимают запросы двух типов:
 - неавторизованные пользователи
 - авторизованные пользователи с сессионой кукой (asp.net cookie authentication)

MS-API работают только с клиентской аутентификацией (OAUTH Client Credentials Grant) и требуют явной передачи id пользователя, в таком случае авторизация должна происходить на уровне BFF или WEBGATEWAY.

MBFF приложение, является частью одной из систем.
Примеры систем:
  веб приложение
  мобильное приложение
  API с бизнес логикой (BasketMs)


## Considered Options
* no client auth + oidc user tokens
* MTLS
* Web gateway JWT

## Pros and Cons of the Options

### no client auth

* Good, нет затрат на реализацию
* Bad, если структура пользовательского токена изменится придется обновлять все MS
* Bad, нет возможности обоготить запрос данными о пользователе
* Bad, BFF не может доверять данным переданым гейтвеем тк возможна атака внутри LAN
  - локаль
  - ip абонента

### MTLS

* Good, because высокий уровень безопасности
* Bad, сложно организовать в k8s и при наличии разнородных реализаций систем хостящихся в вебгейте

### Web gateway JWT

* Good, удобно расширять
* Good, можно кешировать
* Bad, накладные расходы на выпуск JWT
* Bad, накладные расходы на валидацию JWT
* Bad, если у каждого гейта свой ключ, MBFF должен уметь рабоать с несколькими JWKS.
* …

## Decision Outcome

Chosen option: Web gateway JWT позволяет обогошать запрос данными гарантируя что они сформированы гейтвеем